---
alwaysApply: true
---
# üìã Regras para Sistema Multi-WhatsApp (M√∫ltiplos Inboxes)

## Regras Obrigat√≥rias

Este documento define as regras que **DEVEM** ser seguidas ao trabalhar com o sistema de m√∫ltiplas conex√µes WhatsApp.

**IMPORTANTE:** Cada usu√°rio pode ter **M√öLTIPLOS** inboxes/WhatsApps conectados simultaneamente.

---

## üî¥ Regra 1: Cada `connectionId` = Uma Inst√¢ncia Separada

```typescript
// ‚úÖ CORRETO: Map com inst√¢ncias por connectionId (do banco de dados)
const connections = new Map<number, ConnectionInstance>();
// Chave = connectionId (WhatsAppConnection.id no Prisma)

// ‚ùå ERRADO: Map por userId (limita a 1 conex√£o por usu√°rio)
const connections = new Map<number, ConnectionInstance>(); // userId como chave

// ‚ùå ERRADO: Vari√°veis globais compartilhadas
let sock: WASocket | null = null;
```

**Por qu√™?** Cada usu√°rio pode ter **M√öLTIPLOS** n√∫meros de WhatsApp conectados.

---

## üî¥ Regra 2: Sempre Passar `connectionId` (e `userId`) nas Fun√ß√µes

Todas as fun√ß√µes relacionadas a Baileys **DEVEM** receber o `connectionId` como primeiro par√¢metro:

```typescript
// ‚úÖ CORRETO - connectionId primeiro, depois userId quando necess√°rio
export async function getChats(connectionId: number, userId: number) { ... }
export async function sendMessage(connectionId: number, userId: number, chatId: string, text: string) { ... }
export function getConnectionStatus(connectionId: number) { ... }
export async function initBaileysConnection(connectionId: number, userId: number) { ... }

// ‚ùå ERRADO - Sem connectionId ou s√≥ userId
export async function getChats(userId: number) { ... }
export async function sendMessage(userId: number, chatId: string, text: string) { ... }
```

---

## üî¥ Regra 3: Verificar Assinaturas de Fun√ß√µes Antes de Chamar

Antes de chamar qualquer fun√ß√£o, **SEMPRE** verificar a assinatura:

```typescript
// Fun√ß√£o grantNumberAccess em permissions.ts:
export async function grantNumberAccess(
    userId: number,
    connectionId: number,
    permissions: {           // <-- OBJETO, n√£o booleans separados!
        canRead?: boolean;
        canWrite?: boolean;
        canManage?: boolean;
    },
    grantedBy?: number       // <-- Opcional, n√∫mero ou undefined
)

// ‚úÖ CORRETO
await grantNumberAccess(userId, connectionId, {
    canRead: true,
    canWrite: true,
    canManage: true,
});

// ‚ùå ERRADO
await grantNumberAccess(userId, connectionId, true, true, true, true);
```

---

## üî¥ Regra 4: Usar `connections.get(connectionId)` ao Inv√©s de `userId`

Sempre buscar inst√¢ncia pelo `connectionId`:

```typescript
// ‚úÖ CORRETO
const instance = connections.get(connectionId);
if (instance?.sock && instance.connectionStatus === 'connected') { ... }

// ‚ùå ERRADO - Buscar por userId
const instance = connections.get(userId); // N√£o funciona com m√∫ltiplos inboxes!
```

---

## üî¥ Regra 5: Event Listeners por Inst√¢ncia

Cada conex√£o registra seus pr√≥prios event listeners:

```typescript
// ‚úÖ CORRETO - Usa connectionId da inst√¢ncia
instance.sock.ev.on('messages.upsert', async ({ messages, type }) => {
    await saveMessageToDB(msg, connectionId); // connectionId do escopo
});

// ‚ùå ERRADO - Vari√°vel global
sock.ev.on('messages.upsert', async ({ messages, type }) => {
    await saveMessageToDB(msg, connectionId); // connectionId global!
});
```

---

## üî¥ Regra 6: APIs Usam `connectionId` na URL

Todas as APIs de inbox devem ter o `connectionId` no path:

```typescript
// ‚úÖ CORRETO - connectionId na URL
GET  /api/baileys/inboxes                        // Lista todos os inboxes do usu√°rio
POST /api/baileys/inboxes                        // Cria novo inbox
GET  /api/baileys/inboxes/[connectionId]/status  // Status de um inbox espec√≠fico
POST /api/baileys/inboxes/[connectionId]/connect // Conecta um inbox espec√≠fico
GET  /api/baileys/inboxes/[connectionId]/chats   // Chats de um inbox espec√≠fico
POST /api/baileys/inboxes/[connectionId]/send    // Envia mensagem via inbox espec√≠fico

// ‚ùå ERRADO - Sem connectionId (amb√≠guo quando h√° m√∫ltiplos)
GET  /api/baileys/status                         // Qual inbox?
POST /api/baileys/connect                        // Conectar qual?
```

---

## üî¥ Regra 7: Criar Inbox ANTES de Conectar

O registro `WhatsAppConnection` deve existir no banco ANTES de iniciar a conex√£o:

```typescript
// ‚úÖ CORRETO - Criar slot primeiro, depois conectar
const connectionId = await createInboxSlot(userId, "Vendas");
await initBaileysConnection(connectionId, userId);

// ‚ùå ERRADO - Conectar sem ter registro no banco
await initBaileysConnection(null, userId); // connectionId null!
```

---

## üî¥ Regra 8: Pastas de Autentica√ß√£o Separadas por `connectionId`

Cada conex√£o deve ter sua pr√≥pria pasta de credenciais:

```typescript
// ‚úÖ CORRETO - Pasta por connectionId
const authFolder = `auth_info_baileys_conn_${connectionId}`;
// Resulta em: auth_info_baileys_conn_1, auth_info_baileys_conn_5, etc.

// ‚ùå ERRADO - Pasta por userId (limita a 1 inbox por usu√°rio)
const authFolder = `auth_info_baileys_${userId}`;

// ‚ùå ERRADO - Pasta compartilhada
const authFolder = 'auth_info_baileys';
```

---

## üî¥ Regra 9: Garantir `NumberAccess` em Conex√µes

Quando um usu√°rio conecta a um n√∫mero, garantir que ele tem permiss√£o:

```typescript
// Ao criar nova conex√£o ou reconectar
const existingAccess = await prisma.numberAccess.findFirst({
    where: { userId, connectionId }
});

if (!existingAccess) {
    await grantNumberAccess(userId, connectionId, {
        canRead: true,
        canWrite: true,
        canManage: true,
    });
}
```

---

## üî¥ Regra 10: Logs Sempre com `connectionId`

Todos os logs devem identificar qual conex√£o:

```typescript
// ‚úÖ CORRETO
console.log(`üì© Connection #${connectionId}: Received ${messages.length} message(s)`);
console.log(`‚úÖ Connection #${connectionId}: Message saved`);

// ‚ùå ERRADO
console.log(`Received ${messages.length} messages`);  // Qual conex√£o?
```

---

## üìã Checklist de Revis√£o de C√≥digo

Antes de fazer commit, verificar:

- [ ] Todas as fun√ß√µes de Baileys recebem `connectionId`?
- [ ] Estou usando `connections.get(connectionId)` ao inv√©s de `userId`?
- [ ] As chamadas de fun√ß√£o usam os tipos corretos de par√¢metros?
- [ ] O `connectionId` √© criado via `createInboxSlot` antes de conectar?
- [ ] Os logs identificam o `connectionId`?
- [ ] As rotas de API usam `connectionId` na URL?
- [ ] As pastas de auth s√£o separadas por `connectionId`?
- [ ] `NumberAccess` √© garantido em todas as conex√µes?

---

## üîß Estrutura de Dados Correta

```typescript
interface ConnectionInstance {
    sock: WASocket | null;
    qrCodeData: string | null;
    connectionStatus: 'disconnected' | 'connecting' | 'connected';
    qrCodeTimeout: NodeJS.Timeout | null;
    connectionTimeout: NodeJS.Timeout | null;
    connectionId: number;             // ID no banco de dados (OBRIGAT√ìRIO)
    userId: number;                   // Qual usu√°rio √© dono desta conex√£o
    phoneNumber: string | null;       // N√∫mero conectado (preenchido ap√≥s conex√£o)
}

// Armazenamento por connectionId
const connections = new Map<number, ConnectionInstance>();
```

---

## üåê Fluxo de M√∫ltiplos Inboxes

```
1. Usu√°rio clica em "+ Novo Inbox"
   ‚îî‚îÄ‚îÄ POST /api/baileys/inboxes
       ‚îî‚îÄ‚îÄ createInboxSlot(userId) ‚Üí connectionId

2. Redireciona para /atendente/inbox-pirata/[connectionId]
   ‚îî‚îÄ‚îÄ GET /api/baileys/inboxes/[connectionId]/status
       ‚îî‚îÄ‚îÄ getConnectionStatus(connectionId)

3. Usu√°rio clica em "Conectar WhatsApp"
   ‚îî‚îÄ‚îÄ POST /api/baileys/inboxes/[connectionId]/connect
       ‚îî‚îÄ‚îÄ initBaileysConnection(connectionId, userId)

4. QR Code √© exibido, usu√°rio escaneia
   ‚îî‚îÄ‚îÄ GET /api/baileys/inboxes/[connectionId]/status (polling)
       ‚îî‚îÄ‚îÄ status muda para 'connected'

5. Chats e mensagens s√£o carregados
   ‚îî‚îÄ‚îÄ GET /api/baileys/inboxes/[connectionId]/chats
   ‚îî‚îÄ‚îÄ GET /api/baileys/inboxes/[connectionId]/messages?chatId=xxx
```

---

## üìÖ √öltima Atualiza√ß√£o

**2 de Janeiro de 2026**

